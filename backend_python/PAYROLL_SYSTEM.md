# üìä Payroll Report System

‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ (‡∏£‡∏õ‡∏†.)

## üéØ ‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏´‡∏•‡∏±‡∏Å

### 1. **‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô**
- ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
- ‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô, ‡∏Å‡∏∞‡∏á‡∏≤‡∏ô (‡πÄ‡∏ä‡πâ‡∏≤/‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô), ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
- ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£

### 2. **‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•**
- ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
- ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
- ‡πÅ‡∏¢‡∏Å‡∏ô‡∏±‡∏ö‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤/‡∏Å‡∏∞‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô
- Top 5 ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ö‡πà‡∏≠‡∏¢‡∏™‡∏∏‡∏î

### 3. **‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•**
- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô
- ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏´‡∏±‡∏™‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠

## üì° API Endpoints

### GET `/api/schedules/guard/{guard_id}/work-history`
‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô

**Query Parameters:**
- `start_date` (optional): ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (YYYY-MM-DD)
- `end_date` (optional): ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î (YYYY-MM-DD)

**Response:**
```json
{
  "guardId": "PG-0001",
  "guardName": "‡∏ô‡∏≤‡∏¢ ‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ",
  "dateRange": {
    "start": "2025-11-01",
    "end": "2025-11-30"
  },
  "workDays": [
    {
      "date": "2025-11-30",
      "siteId": 2,
      "siteName": "‡∏´‡∏ô‡πà‡∏ß‡∏¢ B",
      "shift": "day",
      "position": "‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢",
      "dailyIncome": 580.0,
      "payoutRate": 24500.0,
      "hiringRate": 24500.0,
      "allowances": {
        "positionAllowance": 0.0,
        "diligenceBonus": 1000.0,
        "sevenDayBonus": 0.0,
        "pointBonus": 0.0,
        "otherAllowance": 0.0
      },
      "totalIncome": 25500.0
    }
  ],
  "summary": {
    "totalWorkDays": 25,
    "totalIncome": 52500.0,
    "dayShiftCount": 20,
    "nightShiftCount": 5
  }
}
```

### GET `/api/schedules/guard/{guard_id}/summary`
‡∏î‡∏∂‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡∏¢‡πà‡∏≠ (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ß‡∏±‡∏ô)

**Query Parameters:**
- `start_date` (optional): ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (YYYY-MM-DD)
- `end_date` (optional): ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î (YYYY-MM-DD)

**Response:**
```json
{
  "guardId": "PG-0001",
  "guardName": "‡∏ô‡∏≤‡∏¢ ‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ",
  "dateRange": {
    "start": "2025-11-01",
    "end": "2025-11-30"
  },
  "totalWorkDays": 25,
  "totalIncome": 52500.0,
  "dayShiftCount": 20,
  "nightShiftCount": 5,
  "topSites": [
    {
      "siteName": "‡∏´‡∏ô‡πà‡∏ß‡∏¢ B",
      "workDays": 15
    },
    {
      "siteName": "‡∏´‡∏ô‡πà‡∏ß‡∏¢ A",
      "workDays": 10
    }
  ]
}
```

## üóÑÔ∏è Database Schema

### Table: `schedule_guards`
‡∏ï‡∏≤‡∏£‡∏≤‡∏á denormalized ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö query ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß

**Columns:**
- `id`: Primary key
- `scheduleId`: FK to schedules.id (CASCADE delete)
- `scheduleDate`: ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡∏°‡∏µ index)
- `guardId`: ‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡πÄ‡∏ä‡πà‡∏ô PG-0001 (‡∏°‡∏µ index)
- `guard_id_fk`: FK to guards.id (SET NULL on delete)
- `guardName`: ‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•
- `siteId`: FK to sites.id (CASCADE delete)
- `siteName`: ‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô
- `shift`: ‡∏Å‡∏∞‡∏á‡∏≤‡∏ô (day/night) (‡∏°‡∏µ index)
- `position`: ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏á‡∏≤‡∏ô
- `dailyIncome`: ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ/‡∏ß‡∏±‡∏ô (‡∏ê‡∏≤‡∏ô)
- `payoutRate`: ‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á
- `hiringRate`: ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏à‡πâ‡∏≤‡∏á
- `positionAllowance`: ‡∏Ñ‡πà‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
- `diligenceBonus`: ‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏Ç‡∏¢‡∏±‡∏ô
- `sevenDayBonus`: 7DAY
- `pointBonus`: ‡∏Ñ‡πà‡∏≤‡∏à‡∏∏‡∏î
- `otherAllowance`: ‡∏Ñ‡πà‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ
- `createdAt`: ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•

**Indexes:**
- `idx_schedule_guard_query`: (guardId, scheduleDate) - ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö query ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
- `idx_schedule_guard_date_range`: (guardId, scheduleDate, shift) - ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö filter ‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
- Single column indexes: scheduleId, scheduleDate, guardId, guard_id_fk, siteId, shift

## üîÑ Data Synchronization

### Automatic Sync
‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£ (`schedules`), ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞ sync ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á `schedule_guards` ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥

**API Endpoints ‡∏ó‡∏µ‡πà‡∏°‡∏µ Auto-Sync:**
- `POST /api/schedules` - ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£
- `PUT /api/schedules/{id}` - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£
- `DELETE /api/schedules/{id}/hard` - ‡∏•‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£ (CASCADE ‡πÑ‡∏õ schedule_guards)

### Manual Backfill
‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ sync:

```bash
cd backend_python
python backfill_schedule_guards.py
```

### Check Sync Status
‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• sync ‡∏Ñ‡∏£‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà:

```bash
cd backend_python
python check_sync_status.py
```

## üöÄ ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô

### 1. ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
- Login ‡∏î‡πâ‡∏ß‡∏¢ username/password
- ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÄ‡∏°‡∏ô‡∏π "‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô"

### 2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
- ‡πÉ‡∏ä‡πâ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
- ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£

### 3. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤
- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î
- ‡∏Ñ‡∏•‡∏¥‡∏Å "‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"

### 4. Export ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (Coming Soon)
- ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° "Export Excel" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô

## üîß ‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ï‡πà‡∏≠

### TODO List
- [ ] Export to Excel (xlsx format)
- [ ] Export to PDF with formatting
- [ ] Bulk payroll report (all guards)
- [ ] Monthly summary report
- [ ] Print-friendly view
- [ ] Email report delivery
- [ ] Payroll approval workflow
- [ ] Integration with accounting system

## üìù Notes

- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å sync ‡∏à‡∏≤‡∏Å `schedules` table ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
- ‡∏Å‡∏≤‡∏£‡∏•‡∏ö schedule ‡∏à‡∏∞‡∏•‡∏ö schedule_guards ‡∏î‡πâ‡∏ß‡∏¢ (CASCADE)
- ‡∏Å‡∏≤‡∏£‡∏•‡∏ö guard ‡∏à‡∏∞‡πÄ‡∏ã‡πá‡∏ï guard_id_fk ‡πÄ‡∏õ‡πá‡∏ô NULL (‡∏¢‡∏±‡∏á‡πÄ‡∏´‡πá‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ)
- ‡∏Å‡∏≤‡∏£‡∏•‡∏ö site ‡∏à‡∏∞‡∏•‡∏ö schedule_guards ‡∏î‡πâ‡∏ß‡∏¢ (CASCADE)
- Query ‡πÄ‡∏£‡πá‡∏ß‡∏°‡∏≤‡∏Å‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏°‡∏µ proper indexes
- ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö timezone (timestamp with time zone)

## üêõ Troubleshooting

### ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πâ‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
2. ‡∏£‡∏±‡∏ô `python check_sync_status.py` ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ sync
3. ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ backfill: `python backfill_schedule_guards.py`

### ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô
1. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Scheduler
2. ‡∏Å‡∏î Save - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞ sync ‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
3. Refresh ‡∏´‡∏ô‡πâ‡∏≤ Payroll Report

### Performance Issues
- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ indexes ‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏£‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà: `python verify_table.py`
- ‡∏î‡∏π query execution plan ‡πÉ‡∏ô PostgreSQL
- ‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏° indexes ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
